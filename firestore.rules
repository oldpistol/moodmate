rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to get user role from database
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Helper function to check if user is counsellor
    function isCounsellor() {
      return isAuthenticated() && getUserRole() == 'counsellor';
    }
    
    // Helper function to check if user is regular user
    function isUser() {
      return isAuthenticated() && getUserRole() == 'user';
    }
    
    // Users collection rules
    match /users/{userId} {
      // Anyone authenticated can read any user profile (for counsellor matching, etc.)
      allow read: if isAuthenticated();
      
      // Users can only create their own profile during registration
      allow create: if isOwner(userId) 
                    && request.resource.data.keys().hasAll(['name', 'email', 'role', 'createdAt', 'updatedAt'])
                    && request.resource.data.role in ['user', 'counsellor', 'admin'];
      
      // Users can only update their own profile
      allow update: if isOwner(userId)
                    && request.resource.data.role == resource.data.role; // Cannot change role
      
      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }
    
    // Mood entries collection rules
    match /mood_entries/{entryId} {
      // Users can only read their own mood entries
      // Counsellors can read their assigned clients' entries
      allow read: if isOwner(resource.data.userId) 
                  || (isCounsellor() && isAssignedCounsellor(resource.data.userId));
      
      // Users can only create their own mood entries
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['userId', 'text', 'timestamp']);
      
      // Users can update their own entries within 24 hours of creation
      // Cloud Functions can also update entries (for AI analysis results)
      allow update: if isOwner(resource.data.userId)
                    && request.time < resource.data.timestamp + duration.value(24, 'h');
      
      // Users can delete their own entries
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Helper function to check if counsellor is assigned to user
    function isAssignedCounsellor(userId) {
      return exists(/databases/$(database)/documents/counsellor_assignments/$(userId))
          && get(/databases/$(database)/documents/counsellor_assignments/$(userId)).data.counsellorId == request.auth.uid
          && get(/databases/$(database)/documents/counsellor_assignments/$(userId)).data.isActive == true;
    }
    
    // Counsellor assignments collection rules
    match /counsellor_assignments/{userId} {
      // Users can read their own assignment
      // Counsellors can read assignments they're part of and query their assignments
      allow read: if isOwner(userId) 
                  || (isCounsellor() && resource.data.counsellorId == request.auth.uid)
                  || isAdmin();
      
      // Allow counsellors to query their assignments
      allow list: if isCounsellor() || isAdmin();
      
      // Only counsellors and admins can create assignments
      allow create: if (isCounsellor() && request.resource.data.counsellorId == request.auth.uid)
                    || isAdmin();
      
      // Only the assigned counsellor or admin can update
      allow update: if (isCounsellor() && resource.data.counsellorId == request.auth.uid) 
                    || isAdmin();
      
      // Only admins can delete assignments
      allow delete: if isAdmin();
    }
    
    // Messages collection rules
    match /messages/{messageId} {
      // Users can read messages where they are sender or recipient
      allow read: if isAuthenticated() 
                  && (resource.data.senderId == request.auth.uid 
                      || resource.data.recipientId == request.auth.uid);
      
      // Users can send messages to their assigned counsellor
      // Counsellors can send messages to their assigned clients
      allow create: if isAuthenticated()
                    && request.resource.data.senderId == request.auth.uid
                    && (
                      (isUser() && isAssignedCounsellor(request.auth.uid))
                      || (isCounsellor() && isAssignedCounsellor(request.resource.data.recipientId))
                    );
      
      // Messages cannot be updated or deleted (only soft delete via status field)
      allow update: if isAuthenticated()
                    && resource.data.senderId == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);
      
      allow delete: if false; // Hard delete not allowed
    }
    
    // Recommendations collection rules
    match /recommendations/{recommendationId} {
      // Users can read their own recommendations
      allow read: if isOwner(resource.data.userId);
      
      // System (Cloud Functions) can create recommendations
      // In practice, only Cloud Functions should write here
      allow create: if false; // Will be created by Cloud Functions
      
      // Cannot update or delete recommendations
      allow update, delete: if false;
    }
    
    // Admin-only collections
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Counsellors collection rules
    match /counsellors/{counsellorId} {
      // Anyone authenticated can read counsellor profiles
      allow read: if isAuthenticated();
      
      // Only admins can create counsellor profiles
      allow create: if isAdmin()
                    && request.resource.data.keys().hasAll(['name', 'email', 'status', 'createdAt', 'updatedAt']);
      
      // Counsellors can update their own profile
      // Admins can update any counsellor profile
      allow update: if (isCounsellor() && request.auth.uid == counsellorId)
                    || isAdmin();
      
      // Only admins can delete counsellor profiles
      allow delete: if isAdmin();
    }
    
    // Support requests collection rules
    match /support_requests/{requestId} {
      // Users can read their own support requests
      // Counsellors can read requests assigned to them or pending requests
      allow read: if isOwner(resource.data.userId)
                  || (isCounsellor() && (resource.data.counsellorId == request.auth.uid || resource.data.status == 'pending'))
                  || isAdmin();
      
      // Users can create support requests
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['userId', 'status', 'createdAt', 'updatedAt'])
                    && request.resource.data.status == 'pending';
      
      // Users can update their own pending requests (to cancel)
      // Counsellors can accept/update requests
      // Admins can update any request
      allow update: if (isOwner(resource.data.userId) && resource.data.status == 'pending')
                    || (isCounsellor() && (resource.data.counsellorId == request.auth.uid || resource.data.status == 'pending'))
                    || isAdmin();
      
      // Only admins can delete support requests
      allow delete: if isAdmin();
    }
    
    // Conversation threads collection rules
    match /conversation_threads/{threadId} {
      // Users and counsellors can read their own conversation threads
      allow read: if isAuthenticated()
                  && (resource.data.userId == request.auth.uid
                      || resource.data.counsellorId == request.auth.uid)
                  || isAdmin();
      
      // Only the system (Cloud Functions) can create conversation threads
      allow create: if false; // Created by Cloud Functions
      
      // Participants can update thread metadata (e.g., last message time)
      allow update: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || resource.data.counsellorId == request.auth.uid)
                    || isAdmin();
      
      // Only admins can delete conversation threads
      allow delete: if isAdmin();
      
      // Messages subcollection within conversation threads
      match /messages/{messageId} {
        // Participants can read messages in their conversation thread
        allow read: if isAuthenticated()
                    && (get(/databases/$(database)/documents/conversation_threads/$(threadId)).data.userId == request.auth.uid
                        || get(/databases/$(database)/documents/conversation_threads/$(threadId)).data.counsellorId == request.auth.uid)
                    || isAdmin();
        
        // Participants can create messages in their conversation thread
        allow create: if isAuthenticated()
                      && request.resource.data.senderId == request.auth.uid
                      && (get(/databases/$(database)/documents/conversation_threads/$(threadId)).data.userId == request.auth.uid
                          || get(/databases/$(database)/documents/conversation_threads/$(threadId)).data.counsellorId == request.auth.uid);
        
        // Sender can update their own message (e.g., mark as edited)
        allow update: if isAuthenticated()
                      && resource.data.senderId == request.auth.uid;
        
        // Only admins can delete messages
        allow delete: if isAdmin();
      }
    }
  }
}
